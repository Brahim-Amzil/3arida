"use strict";exports.id=6471,exports.ids=[6471],exports.modules={78653:(e,t,r)=>{r.d(t,{AN:()=>d,DEFAULT_CATEGORIES:()=>i,QI:()=>o,S2:()=>a,SB:()=>s,kC:()=>c,ks:()=>g,xF:()=>u,xG:()=>n,yX:()=>l});let a={free:{name:"Free",maxSignatures:2500,price:0,features:["Up to 2,500 signatures","Basic petition page","Email sharing"]},basic:{name:"Basic",maxSignatures:5e3,price:49,features:["Up to 5,000 signatures","Enhanced petition page","Social media sharing","Basic analytics"]},premium:{name:"Premium",maxSignatures:1e4,price:79,features:["Up to 10,000 signatures","Premium petition page","Advanced sharing","Detailed analytics","Priority support"]},enterprise:{name:"Enterprise",maxSignatures:1e5,price:199,features:["Up to 100,000 signatures","Custom branding","API access","Advanced analytics","Dedicated support"]}},i=[{name:"Environment",description:"Environmental protection and sustainability",icon:"\uD83C\uDF31",color:"green",isActive:!0},{name:"Social Justice",description:"Human rights and social equality",icon:"⚖️",color:"blue",isActive:!0},{name:"Politics",description:"Political reform and governance",icon:"\uD83C\uDFDB️",color:"purple",isActive:!0},{name:"Education",description:"Educational reform and access",icon:"\uD83D\uDCDA",color:"orange",isActive:!0},{name:"Healthcare",description:"Healthcare access and reform",icon:"\uD83C\uDFE5",color:"red",isActive:!0},{name:"Economy",description:"Economic policy and employment",icon:"\uD83D\uDCBC",color:"yellow",isActive:!0},{name:"Infrastructure",description:"Public infrastructure and transportation",icon:"\uD83D\uDEA7",color:"gray",isActive:!0},{name:"Culture",description:"Cultural preservation and arts",icon:"\uD83C\uDFAD",color:"pink",isActive:!0}],o=e=>{let t=[];return(!e.title||e.title.trim().length<10)&&t.push({field:"title",message:"Title must be at least 10 characters long"}),e.title&&e.title.length>200&&t.push({field:"title",message:"Title must not exceed 200 characters"}),(!e.description||e.description.trim().length<50)&&t.push({field:"description",message:"Description must be at least 50 characters long"}),e.description&&e.description.length>5e3&&t.push({field:"description",message:"Description must not exceed 5000 characters"}),e.category||t.push({field:"category",message:"Please select a category"}),(!e.targetSignatures||e.targetSignatures<100)&&t.push({field:"targetSignatures",message:"Target signatures must be at least 100"}),e.targetSignatures>1e5&&t.push({field:"targetSignatures",message:"Target signatures cannot exceed 100,000"}),t},s=(e,t)=>0===t?0:Math.min(e/t*100,100),n=e=>new Intl.NumberFormat("fr-MA",{style:"currency",currency:"MAD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),c=e=>{switch(e){case"draft":default:return"gray";case"pending":return"yellow";case"approved":return"green";case"paused":return"orange";case"deleted":return"red"}},d=e=>{switch(e){case"draft":return"Draft";case"pending":return"Pending Review";case"approved":return"Active";case"paused":return"Paused";case"deleted":return"Deleted";default:return"Unknown"}},u=e=>e<=a.free.maxSignatures?"free":e<=a.basic.maxSignatures?"basic":e<=a.premium.maxSignatures?"premium":"enterprise",l=e=>a[u(e)].price,p=(e,t)=>{let r=e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim(),a=t.slice(-8);return`${r}-${a}`},g=e=>{let t=p(e.title,e.id);return`/petitions/${t}`}},16471:(e,t,r)=>{r.d(t,{Ue:()=>O,MY:()=>x,Ee:()=>Q,CP:()=>L,Am:()=>U,O0:()=>F,GA:()=>V,gt:()=>M,$l:()=>B,at:()=>Y,Qq:()=>k,Sp:()=>$});var a=r(87097),i=r(3913),o=r(81012);let s=async e=>{try{await (0,a.addDoc)((0,a.collection)(o.db,"signatureAttempts"),{...e,timestamp:a.Timestamp.fromDate(new Date)})}catch(e){console.error("Error tracking signature attempt:",e)}},n=async(e,t)=>{try{let r=(0,a.collection)(o.db,"signatures"),i=(0,a.query)(r,(0,a.where)("petitionId","==",e),(0,a.where)("signerPhone","==",t));return!(await (0,a.getDocs)(i)).empty}catch(e){return console.error("Error checking duplicate phone signature:",e),!1}},c=async(e,t,r=24,i=5)=>{try{let s=(0,a.collection)(o.db,"signatureAttempts"),n=new Date(Date.now()-36e5*r),c=(0,a.query)(s,(0,a.where)("petitionId","==",e),(0,a.where)("ipAddress","==",t),(0,a.where)("timestamp",">=",a.Timestamp.fromDate(n)),(0,a.where)("success","==",!0)),d=(await (0,a.getDocs)(c)).size;if(d>=i)return{allowed:!1,count:d,reason:`Too many signatures from this IP address. Maximum ${i} signatures per ${r} hours.`};return{allowed:!0,count:d}}catch(e){return console.error("Error checking IP signature limit:",e),{allowed:!0,count:0}}},d=async e=>{let t={ipAddress:e,riskScore:0,firstSeen:new Date,lastSeen:new Date,totalRequests:1,suspiciousActivity:[]};try{let r=(0,a.collection)(o.db,"ipTracking"),i=(0,a.query)(r,(0,a.where)("ipAddress","==",e)),s=await (0,a.getDocs)(i);if(!s.empty){let t=s.docs[0].data();return{ipAddress:e,country:t.country,city:t.city,isp:t.isp,isVPN:t.isVPN||!1,isProxy:t.isProxy||!1,riskScore:t.riskScore||0,firstSeen:t.firstSeen?.toDate()||new Date,lastSeen:new Date,totalRequests:(t.totalRequests||0)+1,suspiciousActivity:t.suspiciousActivity||[]}}let n=u(e);return{...t,riskScore:n,suspiciousActivity:n>50?["High risk IP range"]:[]}}catch(e){return console.error("Error analyzing IP address:",e),t}},u=e=>{let t=0;for(let r of[/^10\./,/^192\.168\./,/^172\.(1[6-9]|2[0-9]|3[0-1])\./,/^127\./,/^169\.254\./])if(r.test(e)){t+=30;break}for(let r of[/^185\./,/^46\./])if(r.test(e)){t+=20;break}return Math.min(t,100)},l=async(e,t,r,a)=>{if(await n(e,t))return{valid:!1,reason:"This phone number has already been used to sign this petition"};let i=await c(e,r);return i.allowed?(await d(r)).riskScore>80?{valid:!1,reason:"Signature blocked due to high-risk IP address"}:p(a)?{valid:!1,reason:"Signature blocked due to suspicious user agent"}:{valid:!0}:{valid:!1,reason:i.reason}},p=e=>[/bot/i,/crawler/i,/spider/i,/scraper/i,/curl/i,/wget/i,/python/i,/requests/i,/http/i].some(t=>t.test(e)),g=(e,t,a,i)=>{let o=r(6113),s=`${e}:${t}:${a}:${i.getTime()}`;return o.createHash("sha256").update(s).digest("hex")},m={};setInterval(()=>{let e=Date.now();Object.keys(m).forEach(t=>{m[t].resetTime<e&&delete m[t]})},6e4);let h=e=>{let{maxRequests:t,windowMs:r,message:a="Too many requests, please try again later."}=e;return e=>{let i=Date.now(),o=`rate_limit:${e}`,s=m[o];return((!s||s.resetTime<i)&&(s={count:0,resetTime:i+r},m[o]=s),s.count>=t)?{allowed:!1,remaining:0,resetTime:s.resetTime,message:a}:(s.count++,{allowed:!0,remaining:t-s.count,resetTime:s.resetTime})}};h({maxRequests:3,windowMs:36e5,message:"You can only create 3 petitions per hour. Please try again later."}),h({maxRequests:10,windowMs:36e5,message:"You can only sign 10 petitions per hour. Please try again later."}),h({maxRequests:20,windowMs:36e5,message:"You can only post 20 comments per hour. Please try again later."}),h({maxRequests:5,windowMs:9e5,message:"Too many authentication attempts. Please try again in 15 minutes."}),h({maxRequests:3,windowMs:36e5,message:"You can only request 3 password resets per hour."}),h({maxRequests:5,windowMs:36e5,message:"You can only request 5 email verifications per hour."}),h({maxRequests:5,windowMs:36e5,message:"You can only request 5 phone verifications per hour."}),h({maxRequests:100,windowMs:9e5,message:"Too many API requests. Please try again later."});let y=e=>{for(let t of[{pattern:/https?:\/\/[^\s]+/gi,threshold:3,reason:"Too many URLs"},{pattern:/\b\d{10,}\b/g,threshold:2,reason:"Suspicious phone numbers"},{pattern:/(.)\1{10,}/g,threshold:1,reason:"Repeated characters"},{pattern:/[A-Z]{20,}/g,threshold:1,reason:"Excessive caps"},{pattern:/\b(buy|sell|cheap|free|money|cash|prize|winner|congratulations)\b/gi,threshold:5,reason:"Spam keywords"}]){let r=e.match(t.pattern);if(r&&r.length>=t.threshold)return{isSpam:!0,reason:t.reason}}return{isSpam:!1}},f=["spam","scam","fake","fraud","cheat","lie","liar","arnaque","faux","mensonge","menteur","trompeur","كذب","خداع","احتيال","نصب","click here","free money","get rich","make money fast","buy now","limited time","act now","urgent"],w=[/https?:\/\/[^\s]+/gi,/\b\d{10,}\b/g,/(.)\1{5,}/g,/[A-Z]{10,}/g,/\b(buy|sell|cheap|free|money|cash|prize|winner|congratulations)\b/gi,/\b(viagra|cialis|pharmacy|pills|medication)\b/gi,/\b(casino|gambling|poker|lottery|jackpot)\b/gi],D=[],A=(e,t={})=>{let{checkProfanity:r=!0,checkSpam:a=!0,checkHateSpeech:i=!0,strictMode:o=!1,language:s="auto"}=t,n=[],c=1,d=e.toLowerCase().trim();if(r){let e=b(d);e.found&&(n.push(`Contains inappropriate language: ${e.words.join(", ")}`),c-=.3)}if(a){let t=y(e);t.isSpam&&(n.push(`Detected as spam: ${t.reason}`),c-=.4);let r=v(e);r.found&&(n.push(`Contains suspicious patterns: ${r.patterns.join(", ")}`),c-=.2)}i&&P(d).found&&(n.push("Contains hate speech or offensive content"),c-=.5),o&&((e.match(/[A-Z]/g)||[]).length/e.length>.5&&e.length>20&&(n.push("Excessive use of capital letters"),c-=.1),(e.match(/[!?.,;:]/g)||[]).length/e.length>.2&&(n.push("Excessive punctuation"),c-=.1));let u=c>=(o?.8:.6);return{approved:u,confidence:Math.max(0,c),reasons:n,suggestions:u?void 0:S(n)}},b=e=>{let t=[];for(let r of f)e.includes(r.toLowerCase())&&t.push(r);return{found:t.length>0,words:t}},v=e=>{let t=[];for(let r of w)r.test(e)&&t.push(r.source);return{found:t.length>0,patterns:t}},P=e=>{let t=[];for(let r of D)r.test(e)&&t.push(r.source);return{found:t.length>0,patterns:t}},S=e=>{let t=[];return e.some(e=>e.includes("inappropriate language"))&&t.push("Please remove inappropriate language and use respectful terms"),e.some(e=>e.includes("spam"))&&t.push("Please remove promotional content, URLs, and phone numbers"),e.some(e=>e.includes("hate speech"))&&t.push("Please ensure your content is respectful and does not target any group"),e.some(e=>e.includes("capital letters"))&&t.push("Please use normal capitalization instead of ALL CAPS"),e.some(e=>e.includes("punctuation"))&&t.push("Please reduce excessive punctuation marks"),t},T=e=>A(e,{strictMode:!1,checkProfanity:!0,checkSpam:!0,checkHateSpeech:!0});r(73424);var C=r(78653);let E="petitions",I="signatures",q="categories",x=async(e,t,r)=>{let i=(0,C.QI)(e);if(i.length>0)throw Error(`Validation failed: ${i.map(e=>e.message).join(", ")}`);try{let r=new Date,i=(0,C.xF)(e.targetSignatures),s=(0,C.yX)(e.targetSignatures),n={title:e.title.trim(),description:e.description.trim(),category:e.category,subcategory:e.subcategory,targetSignatures:e.targetSignatures,currentSignatures:0,status:s>0?"draft":"pending",creatorId:t,mediaUrls:e.mediaUrls||[],qrCodeUrl:"",hasQrCode:!1,pricingTier:i,amountPaid:0,paymentStatus:s>0?"unpaid":"paid",publisherType:e.publisherType,publisherName:e.publisherName,petitionType:e.petitionType,addressedToType:e.addressedToType,addressedToSpecific:e.addressedToSpecific,youtubeVideoUrl:e.youtubeVideoUrl,tags:e.tags,location:e.location,createdAt:r,updatedAt:r,viewCount:0,shareCount:0,isPublic:!0,isActive:!0},c=await (0,a.addDoc)((0,a.collection)(o.db,E),{...n,createdAt:a.Timestamp.fromDate(n.createdAt),updatedAt:a.Timestamp.fromDate(n.updatedAt)}),d={...n,id:c.id};console.log("✅ Petition created successfully with ID:",c.id),console.log("\uD83D\uDCC4 Created petition data:",d);try{let e=await (0,a.getDoc)(c);e.exists()?(console.log("✅ Verification: Document exists in Firestore"),console.log("\uD83D\uDCC4 Verification data:",e.data())):console.log("❌ Verification: Document does not exist immediately after creation")}catch(e){console.log("❌ Verification error:",e)}return d}catch(e){throw console.error("Error creating petition:",e),Error("Failed to create petition. Please try again.")}},U=async(e,t=0)=>{try{console.log("\uD83D\uDD0D Getting petition with ID/Slug:",e,t>0?`(retry ${t})`:"");let r=(0,a.doc)(o.db,E,e),i=await (0,a.getDoc)(r);if(i.exists())console.log("✅ Petition found by direct ID lookup");else{console.log("\uD83D\uDD0D Direct lookup failed, trying to find by ID suffix...");let r=e.split("-"),i=r[r.length-1];if(i&&i.length>=8){let e=(0,a.query)((0,a.collection)(o.db,E),(0,a.b9)(100)),t=await (0,a.getDocs)(e),r=null;if(t.forEach(e=>{e.id.endsWith(i)&&(r=e)}),r){console.log("✅ Petition found by ID suffix:",r.id);let e=r.data();return{id:r.id,title:e.title,description:e.description,category:e.category,subcategory:e.subcategory,targetSignatures:e.targetSignatures,currentSignatures:e.currentSignatures||0,status:e.status,creatorId:e.creatorId,creatorPageId:e.creatorPageId,mediaUrls:e.mediaUrls||[],qrCodeUrl:e.qrCodeUrl,hasQrCode:e.hasQrCode||!1,pricingTier:e.pricingTier,amountPaid:e.amountPaid||0,paymentStatus:e.paymentStatus||"unpaid",location:e.location,createdAt:e.createdAt?.toDate()||new Date,updatedAt:e.updatedAt?.toDate()||new Date,viewCount:e.viewCount||0,shareCount:e.shareCount||0,isPublic:!1!==e.isPublic,isActive:!1!==e.isActive,publisherType:e.publisherType,publisherName:e.publisherName,petitionType:e.petitionType,addressedToType:e.addressedToType,addressedToSpecific:e.addressedToSpecific,referenceCode:e.referenceCode,youtubeVideoUrl:e.youtubeVideoUrl,tags:e.tags}}}if(0===t)return console.log("❌ Petition not found, retrying in 3 seconds..."),await new Promise(e=>setTimeout(e,3e3)),U(e,1);if(1===t)return console.log("❌ Petition still not found, final retry in 5 seconds..."),await new Promise(e=>setTimeout(e,5e3)),U(e,2);return console.log("❌ Petition not found in database after all retries"),null}console.log("✅ Petition found, processing data...");let s=i.data(),n={id:i.id,title:s.title,description:s.description,category:s.category,subcategory:s.subcategory,targetSignatures:s.targetSignatures,currentSignatures:s.currentSignatures||0,status:s.status,creatorId:s.creatorId,creatorPageId:s.creatorPageId,mediaUrls:s.mediaUrls||[],qrCodeUrl:s.qrCodeUrl,hasQrCode:s.hasQrCode||!1,pricingTier:s.pricingTier,amountPaid:s.amountPaid||0,paymentStatus:s.paymentStatus||"unpaid",location:s.location,createdAt:s.createdAt?.toDate?s.createdAt.toDate():s.createdAt||new Date,updatedAt:s.updatedAt?.toDate?s.updatedAt.toDate():s.updatedAt||new Date,approvedAt:s.approvedAt?.toDate?s.approvedAt.toDate():s.approvedAt,pausedAt:s.pausedAt?.toDate?s.pausedAt.toDate():s.pausedAt,deletedAt:s.deletedAt?.toDate?s.deletedAt.toDate():s.deletedAt,viewCount:s.viewCount||0,shareCount:s.shareCount||0,moderatedBy:s.moderatedBy,moderationNotes:s.moderationNotes,isPublic:!1!==s.isPublic,isActive:!1!==s.isActive,publisherType:s.publisherType,publisherName:s.publisherName,petitionType:s.petitionType,addressedToType:s.addressedToType,addressedToSpecific:s.addressedToSpecific,referenceCode:s.referenceCode,youtubeVideoUrl:s.youtubeVideoUrl,tags:s.tags};return console.log("✅ Petition processed successfully:",n.id),n}catch(t){return console.error("❌ Error getting petition:",t),console.error("❌ Error details:",{petitionIdOrSlug:e,error:t instanceof Error?t.message:t}),null}},k=async(e,t,r,n="",c="")=>{let d=new Date;try{let u=await U(e);if(!u)throw await s({petitionId:e,ipAddress:n,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:"Petition not found"}),Error("Petition not found");if("approved"!==u.status)throw await s({petitionId:e,ipAddress:n,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:"Petition not approved"}),Error("This petition is not available for signing");if(u.currentSignatures>=u.targetSignatures)throw await s({petitionId:e,ipAddress:n,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:"Target reached"}),Error("This petition has reached its signature goal");let p=await l(e,t.phone,n,c);if(!p.valid)throw await s({petitionId:e,ipAddress:n,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:p.reason}),Error(p.reason||"Security validation failed");if(t.comment){let a=T(t.comment);if(!a.approved)throw await s({petitionId:e,ipAddress:n,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:`Comment moderation failed: ${a.reasons.join(", ")}`}),Error("Your comment contains inappropriate content. Please revise and try again.")}if(r&&await N(e,r))throw Error("You have already signed this petition");if(await R(e,t.phone))throw Error("This phone number has already been used to sign this petition");let m=g(t.phone,n,c,d),h={petitionId:e,signerName:t.isAnonymous?"Anonymous":t.name,signerPhone:t.phone,signerLocation:t.location,verificationMethod:"phone_otp",verifiedAt:d,ipAddress:n,userAgent:c,fingerprint:m,isAnonymous:t.isAnonymous||!1,comment:t.comment,createdAt:d};await (0,a.addDoc)((0,a.collection)(o.db,I),{...h,verifiedAt:a.Timestamp.fromDate(h.verifiedAt),createdAt:a.Timestamp.fromDate(h.createdAt)});let y=(0,a.doc)(o.db,E,e);await (0,a.updateDoc)(y,{currentSignatures:(0,a.nP)(1),updatedAt:a.Timestamp.fromDate(new Date)});let f=u.currentSignatures+1,w=f/u.targetSignatures*100;for(let t of[25,50,75,100]){let r=u.currentSignatures/u.targetSignatures*100;if(w>=t&&r<t){try{await (0,i.V1)(e,u.creatorId,u.title,f,t)}catch(e){console.error("Error sending milestone notification:",e)}break}}await s({petitionId:e,ipAddress:n,userAgent:c,phoneNumber:t.phone,userId:r,success:!0})}catch(i){console.error("Error signing petition:",i);let a=i instanceof Error?i.message:"Unknown error";throw a.includes("already been used")||a.includes("Too many signatures")||a.includes("inappropriate content")||await s({petitionId:e,ipAddress:n,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:a}),Error("Failed to sign petition. Please try again.")}},N=async(e,t)=>{try{let r=(0,a.query)((0,a.collection)(o.db,I),(0,a.where)("petitionId","==",e),(0,a.where)("userId","==",t),(0,a.b9)(1));return!(await (0,a.getDocs)(r)).empty}catch(e){return console.error("Error checking existing signature:",e),!1}},R=async(e,t)=>{try{let r=(0,a.query)((0,a.collection)(o.db,I),(0,a.where)("petitionId","==",e),(0,a.where)("signerPhone","==",t),(0,a.b9)(1));return!(await (0,a.getDocs)(r)).empty}catch(e){return console.error("Error checking phone signature:",e),!1}},F=async(e={},t={page:1,limit:12,total:0,hasMore:!1})=>{try{let r=(0,a.query)((0,a.collection)(o.db,E));r=e.status?(0,a.query)(r,(0,a.where)("status","==",e.status)):(0,a.query)(r,(0,a.where)("status","==","approved")),e.category&&(r=(0,a.query)(r,(0,a.where)("category","==",e.category)));let i="popular"===e.sortBy?"currentSignatures":"signatures"===e.sortBy?"currentSignatures":"createdAt",s=e.sortOrder||"desc";r=(0,a.query)(r,(0,a.orderBy)(i,s)),t.limit&&(r=(0,a.query)(r,(0,a.b9)(t.limit+1)));let n=await (0,a.getDocs)(r),c=[];n.docs.forEach((e,r)=>{if(t.limit&&r>=t.limit)return;let a=e.data();c.push({id:e.id,title:a.title,description:a.description,category:a.category,subcategory:a.subcategory,targetSignatures:a.targetSignatures,currentSignatures:a.currentSignatures||0,status:a.status,creatorId:a.creatorId,creatorPageId:a.creatorPageId,mediaUrls:a.mediaUrls||[],qrCodeUrl:a.qrCodeUrl,hasQrCode:a.hasQrCode||!1,pricingTier:a.pricingTier,amountPaid:a.amountPaid||0,paymentStatus:a.paymentStatus||"unpaid",location:a.location,createdAt:a.createdAt?.toDate()||new Date,updatedAt:a.updatedAt?.toDate()||new Date,approvedAt:a.approvedAt?.toDate(),pausedAt:a.pausedAt?.toDate(),deletedAt:a.deletedAt?.toDate(),viewCount:a.viewCount||0,shareCount:a.shareCount||0,moderatedBy:a.moderatedBy,moderationNotes:a.moderationNotes,isPublic:!1!==a.isPublic,isActive:!1!==a.isActive})});let d=c;if(e.search){let t=e.search.toLowerCase();d=c.filter(e=>e.title.toLowerCase().includes(t)||e.description.toLowerCase().includes(t))}e.location&&(d=d.filter(t=>t.location?.country===e.location||t.location?.city===e.location));let u={page:t.page||1,limit:t.limit||12,total:d.length,hasMore:d.length===t.limit};return{petitions:d,pagination:u}}catch(e){throw console.error("Error getting petitions:",e),Error("Failed to load petitions. Please try again.")}},M=async e=>{try{let t=(0,a.query)((0,a.collection)(o.db,E),(0,a.where)("creatorId","==",e),(0,a.orderBy)("createdAt","desc")),r=await (0,a.getDocs)(t),i=[];return r.forEach(e=>{let t=e.data();i.push({id:e.id,title:t.title,description:t.description,category:t.category,subcategory:t.subcategory,targetSignatures:t.targetSignatures,currentSignatures:t.currentSignatures||0,status:t.status,creatorId:t.creatorId,creatorPageId:t.creatorPageId,mediaUrls:t.mediaUrls||[],qrCodeUrl:t.qrCodeUrl,hasQrCode:t.hasQrCode||!1,pricingTier:t.pricingTier,amountPaid:t.amountPaid||0,paymentStatus:t.paymentStatus||"unpaid",location:t.location,createdAt:t.createdAt?.toDate()||new Date,updatedAt:t.updatedAt?.toDate()||new Date,approvedAt:t.approvedAt?.toDate(),pausedAt:t.pausedAt?.toDate(),deletedAt:t.deletedAt?.toDate(),viewCount:t.viewCount||0,shareCount:t.shareCount||0,moderatedBy:t.moderatedBy,moderationNotes:t.moderationNotes,isPublic:!1!==t.isPublic,isActive:!1!==t.isActive})}),i}catch(e){throw console.error("Error getting user petitions:",e),Error("Failed to load your petitions. Please try again.")}},$=async(e,t,r,i)=>{try{let s=(0,a.doc)(o.db,E,e),n={status:t,moderatedBy:r,updatedAt:a.Timestamp.fromDate(new Date)};i&&(n.moderationNotes=i),"approved"===t?n.approvedAt=a.Timestamp.fromDate(new Date):"paused"===t?n.pausedAt=a.Timestamp.fromDate(new Date):"deleted"===t&&(n.deletedAt=a.Timestamp.fromDate(new Date),n.isActive=!1),await (0,a.updateDoc)(s,n)}catch(e){throw console.error("Error updating petition status:",e),Error("Failed to update petition status. Please try again.")}},B=async e=>{try{let t=(0,a.doc)(o.db,E,e);await (0,a.updateDoc)(t,{shareCount:(0,a.nP)(1),updatedAt:a.Timestamp.fromDate(new Date)})}catch(e){console.error("Error incrementing petition shares:",e)}},L=async()=>{try{let e=(0,a.collection)(o.db,q),t=await (0,a.getDocs)(e),r=[];if(t.forEach(e=>{let t=e.data();!1!==t.isActive&&r.push({id:e.id,name:t.name,description:t.description,icon:t.icon,color:t.color,isActive:!1!==t.isActive,petitionCount:t.petitionCount||0,createdAt:t.createdAt?.toDate()||new Date,updatedAt:t.updatedAt?.toDate()||new Date})}),0===r.length)return console.log("No categories found in database, using defaults"),C.DEFAULT_CATEGORIES.map((e,t)=>({id:`default-${t}`,...e,petitionCount:0,createdAt:new Date,updatedAt:new Date}));return r.sort((e,t)=>e.name.localeCompare(t.name)),r}catch(e){return console.error("Error getting categories:",e),C.DEFAULT_CATEGORIES.map((e,t)=>({id:`default-${t}`,...e,petitionCount:0,createdAt:new Date,updatedAt:new Date}))}};(async()=>{try{let e=(0,a.collection)(o.db,q);if((await (0,a.getDocs)(e)).empty){let t=new Date,r=C.DEFAULT_CATEGORIES.map(r=>(0,a.addDoc)(e,{...r,petitionCount:0,createdAt:a.Timestamp.fromDate(t),updatedAt:a.Timestamp.fromDate(t)}));await Promise.all(r),console.log("Default categories initialized")}}catch(e){console.error("Error initializing categories:",e)}})();let V=async e=>{try{let t=(0,a.doc)(o.db,"users",e),r=await (0,a.getDoc)(t);if(!r.exists())return null;let i=r.data();return{id:r.id,email:i.email||"",name:i.name||"",role:i.role||"user",phone:i.phone||"",verifiedEmail:i.emailVerified||!1,verifiedPhone:i.phoneVerified||!1,createdAt:i.createdAt?.toDate()||new Date,updatedAt:i.updatedAt?.toDate()||new Date,isActive:!1!==i.isActive,...i.bio&&{bio:i.bio},...i.photoURL&&{photoURL:i.photoURL}}}catch(e){return console.error("Error getting user:",e),null}},Q=async(e,t)=>{try{let r=(0,a.doc)(o.db,E,e),i=await (0,a.getDoc)(r);if(!i.exists())throw Error("Petition not found");if(i.data().creatorId!==t)throw Error("Only the petition creator can delete this petition");await (0,a.updateDoc)(r,{status:"deleted",deletedAt:new Date,updatedAt:new Date})}catch(e){throw console.error("Error deleting petition:",e),e}},O=async(e,t)=>{try{let r=(0,a.doc)(o.db,E,e),i=await (0,a.getDoc)(r);if(!i.exists())throw Error("Petition not found");if(i.data().creatorId!==t)throw Error("Only the petition creator can archive this petition");await (0,a.updateDoc)(r,{status:"archived",archivedAt:new Date,updatedAt:new Date})}catch(e){throw console.error("Error archiving petition:",e),e}},Y=async(e,t,r)=>{try{let i=(0,a.collection)(o.db,"deletion_requests");await (0,a.addDoc)(i,{petitionId:e,requestedBy:t,reason:r,status:"pending",createdAt:new Date})}catch(e){throw console.error("Error requesting petition deletion:",e),e}}}};
"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[63],{8161:function(e,t,r){r.d(t,{AN:function(){return u},DEFAULT_CATEGORIES:function(){return i},QI:function(){return o},S2:function(){return a},SB:function(){return n},kC:function(){return c},ks:function(){return g},xF:function(){return d},xG:function(){return s},yX:function(){return l}});let a={free:{name:"Free",maxSignatures:2500,price:0,features:["Up to 2,500 signatures","Basic petition page","Email sharing"]},basic:{name:"Basic",maxSignatures:5e3,price:49,features:["Up to 5,000 signatures","Enhanced petition page","Social media sharing","Basic analytics"]},premium:{name:"Premium",maxSignatures:1e4,price:79,features:["Up to 10,000 signatures","Premium petition page","Advanced sharing","Detailed analytics","Priority support"]},enterprise:{name:"Enterprise",maxSignatures:1e5,price:199,features:["Up to 100,000 signatures","Custom branding","API access","Advanced analytics","Dedicated support"]}},i=[{name:"Environment",description:"Environmental protection and sustainability",icon:"\uD83C\uDF31",color:"green",isActive:!0},{name:"Social Justice",description:"Human rights and social equality",icon:"⚖️",color:"blue",isActive:!0},{name:"Politics",description:"Political reform and governance",icon:"\uD83C\uDFDB️",color:"purple",isActive:!0},{name:"Education",description:"Educational reform and access",icon:"\uD83D\uDCDA",color:"orange",isActive:!0},{name:"Healthcare",description:"Healthcare access and reform",icon:"\uD83C\uDFE5",color:"red",isActive:!0},{name:"Economy",description:"Economic policy and employment",icon:"\uD83D\uDCBC",color:"yellow",isActive:!0},{name:"Infrastructure",description:"Public infrastructure and transportation",icon:"\uD83D\uDEA7",color:"gray",isActive:!0},{name:"Culture",description:"Cultural preservation and arts",icon:"\uD83C\uDFAD",color:"pink",isActive:!0}],o=e=>{let t=[];return(!e.title||e.title.trim().length<10)&&t.push({field:"title",message:"Title must be at least 10 characters long"}),e.title&&e.title.length>200&&t.push({field:"title",message:"Title must not exceed 200 characters"}),(!e.description||e.description.trim().length<50)&&t.push({field:"description",message:"Description must be at least 50 characters long"}),e.description&&e.description.length>5e3&&t.push({field:"description",message:"Description must not exceed 5000 characters"}),e.category||t.push({field:"category",message:"Please select a category"}),(!e.targetSignatures||e.targetSignatures<100)&&t.push({field:"targetSignatures",message:"Target signatures must be at least 100"}),e.targetSignatures>1e5&&t.push({field:"targetSignatures",message:"Target signatures cannot exceed 100,000"}),t},n=(e,t)=>0===t?0:Math.min(e/t*100,100),s=e=>new Intl.NumberFormat("fr-MA",{style:"currency",currency:"MAD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),c=e=>{switch(e){case"draft":default:return"gray";case"pending":return"yellow";case"approved":return"green";case"paused":return"orange";case"deleted":return"red"}},u=e=>{switch(e){case"draft":return"Draft";case"pending":return"Pending Review";case"approved":return"Active";case"paused":return"Paused";case"deleted":return"Deleted";default:return"Unknown"}},d=e=>e<=a.free.maxSignatures?"free":e<=a.basic.maxSignatures?"basic":e<=a.premium.maxSignatures?"premium":"enterprise",l=e=>a[d(e)].price,p=(e,t)=>{let r=e.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim(),a=t.slice(-8);return"".concat(r,"-").concat(a)},g=e=>{let t=p(e.title,e.id);return"/petitions/".concat(t)}},8063:function(e,t,r){r.d(t,{Ue:function(){return O},MY:function(){return x},Ee:function(){return _},CP:function(){return V},Am:function(){return U},O0:function(){return F},GA:function(){return Q},gt:function(){return M},$l:function(){return L},at:function(){return Y},Qq:function(){return k},Sp:function(){return B}});var a=r(8121),i=r(9289),o=r(1221);let n=async e=>{try{await (0,a.addDoc)((0,a.collection)(o.db,"signatureAttempts"),{...e,timestamp:a.Timestamp.fromDate(new Date)})}catch(e){console.error("Error tracking signature attempt:",e)}},s=async(e,t)=>{try{let r=(0,a.collection)(o.db,"signatures"),i=(0,a.query)(r,(0,a.where)("petitionId","==",e),(0,a.where)("signerPhone","==",t));return!(await (0,a.getDocs)(i)).empty}catch(e){return console.error("Error checking duplicate phone signature:",e),!1}},c=async function(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:24,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5;try{let n=(0,a.collection)(o.db,"signatureAttempts"),s=new Date(Date.now()-36e5*r),c=(0,a.query)(n,(0,a.where)("petitionId","==",e),(0,a.where)("ipAddress","==",t),(0,a.where)("timestamp",">=",a.Timestamp.fromDate(s)),(0,a.where)("success","==",!0)),u=(await (0,a.getDocs)(c)).size;if(u>=i)return{allowed:!1,count:u,reason:"Too many signatures from this IP address. Maximum ".concat(i," signatures per ").concat(r," hours.")};return{allowed:!0,count:u}}catch(e){return console.error("Error checking IP signature limit:",e),{allowed:!0,count:0}}},u=async e=>{let t={ipAddress:e,riskScore:0,firstSeen:new Date,lastSeen:new Date,totalRequests:1,suspiciousActivity:[]};try{let i=(0,a.collection)(o.db,"ipTracking"),n=(0,a.query)(i,(0,a.where)("ipAddress","==",e)),s=await (0,a.getDocs)(n);if(!s.empty){var r;let t=s.docs[0].data();return{ipAddress:e,country:t.country,city:t.city,isp:t.isp,isVPN:t.isVPN||!1,isProxy:t.isProxy||!1,riskScore:t.riskScore||0,firstSeen:(null===(r=t.firstSeen)||void 0===r?void 0:r.toDate())||new Date,lastSeen:new Date,totalRequests:(t.totalRequests||0)+1,suspiciousActivity:t.suspiciousActivity||[]}}let c=d(e);return{...t,riskScore:c,suspiciousActivity:c>50?["High risk IP range"]:[]}}catch(e){return console.error("Error analyzing IP address:",e),t}},d=e=>{let t=0;for(let r of[/^10\./,/^192\.168\./,/^172\.(1[6-9]|2[0-9]|3[0-1])\./,/^127\./,/^169\.254\./])if(r.test(e)){t+=30;break}for(let r of[/^185\./,/^46\./])if(r.test(e)){t+=20;break}return Math.min(t,100)},l=async(e,t,r,a)=>{if(await s(e,t))return{valid:!1,reason:"This phone number has already been used to sign this petition"};let i=await c(e,r);return i.allowed?(await u(r)).riskScore>80?{valid:!1,reason:"Signature blocked due to high-risk IP address"}:p(a)?{valid:!1,reason:"Signature blocked due to suspicious user agent"}:{valid:!0}:{valid:!1,reason:i.reason}},p=e=>[/bot/i,/crawler/i,/spider/i,/scraper/i,/curl/i,/wget/i,/python/i,/requests/i,/http/i].some(t=>t.test(e)),g=(e,t,a,i)=>{let o=r(4131),n="".concat(e,":").concat(t,":").concat(a,":").concat(i.getTime());return o.createHash("sha256").update(n).digest("hex")},m={};setInterval(()=>{let e=Date.now();Object.keys(m).forEach(t=>{m[t].resetTime<e&&delete m[t]})},6e4);let h=e=>{let{maxRequests:t,windowMs:r,message:a="Too many requests, please try again later."}=e;return e=>{let i=Date.now(),o="rate_limit:".concat(e),n=m[o];return((!n||n.resetTime<i)&&(n={count:0,resetTime:i+r},m[o]=n),n.count>=t)?{allowed:!1,remaining:0,resetTime:n.resetTime,message:a}:(n.count++,{allowed:!0,remaining:t-n.count,resetTime:n.resetTime})}};h({maxRequests:3,windowMs:36e5,message:"You can only create 3 petitions per hour. Please try again later."}),h({maxRequests:10,windowMs:36e5,message:"You can only sign 10 petitions per hour. Please try again later."}),h({maxRequests:20,windowMs:36e5,message:"You can only post 20 comments per hour. Please try again later."}),h({maxRequests:5,windowMs:9e5,message:"Too many authentication attempts. Please try again in 15 minutes."}),h({maxRequests:3,windowMs:36e5,message:"You can only request 3 password resets per hour."}),h({maxRequests:5,windowMs:36e5,message:"You can only request 5 email verifications per hour."}),h({maxRequests:5,windowMs:36e5,message:"You can only request 5 phone verifications per hour."}),h({maxRequests:100,windowMs:9e5,message:"Too many API requests. Please try again later."});let y=e=>{for(let t of[{pattern:/https?:\/\/[^\s]+/gi,threshold:3,reason:"Too many URLs"},{pattern:/\b\d{10,}\b/g,threshold:2,reason:"Suspicious phone numbers"},{pattern:/(.)\1{10,}/g,threshold:1,reason:"Repeated characters"},{pattern:/[A-Z]{20,}/g,threshold:1,reason:"Excessive caps"},{pattern:/\b(buy|sell|cheap|free|money|cash|prize|winner|congratulations)\b/gi,threshold:5,reason:"Spam keywords"}]){let r=e.match(t.pattern);if(r&&r.length>=t.threshold)return{isSpam:!0,reason:t.reason}}return{isSpam:!1}},f=["spam","scam","fake","fraud","cheat","lie","liar","arnaque","faux","mensonge","menteur","trompeur","كذب","خداع","احتيال","نصب","click here","free money","get rich","make money fast","buy now","limited time","act now","urgent"],w=[/https?:\/\/[^\s]+/gi,/\b\d{10,}\b/g,/(.)\1{5,}/g,/[A-Z]{10,}/g,/\b(buy|sell|cheap|free|money|cash|prize|winner|congratulations)\b/gi,/\b(viagra|cialis|pharmacy|pills|medication)\b/gi,/\b(casino|gambling|poker|lottery|jackpot)\b/gi],D=[],v=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{checkProfanity:r=!0,checkSpam:a=!0,checkHateSpeech:i=!0,strictMode:o=!1,language:n="auto"}=t,s=[],c=1,u=e.toLowerCase().trim();if(r){let e=A(u);e.found&&(s.push("Contains inappropriate language: ".concat(e.words.join(", "))),c-=.3)}if(a){let t=y(e);t.isSpam&&(s.push("Detected as spam: ".concat(t.reason)),c-=.4);let r=b(e);r.found&&(s.push("Contains suspicious patterns: ".concat(r.patterns.join(", "))),c-=.2)}i&&P(u).found&&(s.push("Contains hate speech or offensive content"),c-=.5),o&&((e.match(/[A-Z]/g)||[]).length/e.length>.5&&e.length>20&&(s.push("Excessive use of capital letters"),c-=.1),(e.match(/[!?.,;:]/g)||[]).length/e.length>.2&&(s.push("Excessive punctuation"),c-=.1));let d=c>=(o?.8:.6);return{approved:d,confidence:Math.max(0,c),reasons:s,suggestions:d?void 0:S(s)}},A=e=>{let t=[];for(let r of f)e.includes(r.toLowerCase())&&t.push(r);return{found:t.length>0,words:t}},b=e=>{let t=[];for(let r of w)r.test(e)&&t.push(r.source);return{found:t.length>0,patterns:t}},P=e=>{let t=[];for(let r of D)r.test(e)&&t.push(r.source);return{found:t.length>0,patterns:t}},S=e=>{let t=[];return e.some(e=>e.includes("inappropriate language"))&&t.push("Please remove inappropriate language and use respectful terms"),e.some(e=>e.includes("spam"))&&t.push("Please remove promotional content, URLs, and phone numbers"),e.some(e=>e.includes("hate speech"))&&t.push("Please ensure your content is respectful and does not target any group"),e.some(e=>e.includes("capital letters"))&&t.push("Please use normal capitalization instead of ALL CAPS"),e.some(e=>e.includes("punctuation"))&&t.push("Please reduce excessive punctuation marks"),t},T=e=>v(e,{strictMode:!1,checkProfanity:!0,checkSpam:!0,checkHateSpeech:!0});r(955);var C=r(8161);let E="petitions",I="signatures",q="categories",x=async(e,t,r)=>{let i=(0,C.QI)(e);if(i.length>0)throw Error("Validation failed: ".concat(i.map(e=>e.message).join(", ")));try{let r=new Date,i=(0,C.xF)(e.targetSignatures),n=(0,C.yX)(e.targetSignatures),s={title:e.title.trim(),description:e.description.trim(),category:e.category,subcategory:e.subcategory,targetSignatures:e.targetSignatures,currentSignatures:0,status:n>0?"draft":"pending",creatorId:t,mediaUrls:e.mediaUrls||[],qrCodeUrl:"",hasQrCode:!1,pricingTier:i,amountPaid:0,paymentStatus:n>0?"unpaid":"paid",publisherType:e.publisherType,publisherName:e.publisherName,petitionType:e.petitionType,addressedToType:e.addressedToType,addressedToSpecific:e.addressedToSpecific,youtubeVideoUrl:e.youtubeVideoUrl,tags:e.tags,location:e.location,createdAt:r,updatedAt:r,viewCount:0,shareCount:0,isPublic:!0,isActive:!0},c=await (0,a.addDoc)((0,a.collection)(o.db,E),{...s,createdAt:a.Timestamp.fromDate(s.createdAt),updatedAt:a.Timestamp.fromDate(s.updatedAt)}),u={...s,id:c.id};console.log("✅ Petition created successfully with ID:",c.id),console.log("\uD83D\uDCC4 Created petition data:",u);try{let e=await (0,a.getDoc)(c);e.exists()?(console.log("✅ Verification: Document exists in Firestore"),console.log("\uD83D\uDCC4 Verification data:",e.data())):console.log("❌ Verification: Document does not exist immediately after creation")}catch(e){console.log("❌ Verification error:",e)}return u}catch(e){throw console.error("Error creating petition:",e),Error("Failed to create petition. Please try again.")}},U=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;try{var r,i,n,s,c,u,d;console.log("\uD83D\uDD0D Getting petition with ID/Slug:",e,t>0?"(retry ".concat(t,")"):"");let l=(0,a.doc)(o.db,E,e),p=await (0,a.getDoc)(l);if(p.exists())console.log("✅ Petition found by direct ID lookup");else{console.log("\uD83D\uDD0D Direct lookup failed, trying to find by ID suffix...");let r=e.split("-"),i=r[r.length-1];if(i&&i.length>=8){let e=(0,a.query)((0,a.collection)(o.db,E),(0,a.b9)(100)),t=await (0,a.getDocs)(e),r=null;if(t.forEach(e=>{e.id.endsWith(i)&&(r=e)}),r){console.log("✅ Petition found by ID suffix:",r.id);let e=r.data();return{id:r.id,title:e.title,description:e.description,category:e.category,subcategory:e.subcategory,targetSignatures:e.targetSignatures,currentSignatures:e.currentSignatures||0,status:e.status,creatorId:e.creatorId,creatorPageId:e.creatorPageId,mediaUrls:e.mediaUrls||[],qrCodeUrl:e.qrCodeUrl,hasQrCode:e.hasQrCode||!1,pricingTier:e.pricingTier,amountPaid:e.amountPaid||0,paymentStatus:e.paymentStatus||"unpaid",location:e.location,createdAt:(null===(u=e.createdAt)||void 0===u?void 0:u.toDate())||new Date,updatedAt:(null===(d=e.updatedAt)||void 0===d?void 0:d.toDate())||new Date,viewCount:e.viewCount||0,shareCount:e.shareCount||0,isPublic:!1!==e.isPublic,isActive:!1!==e.isActive,publisherType:e.publisherType,publisherName:e.publisherName,petitionType:e.petitionType,addressedToType:e.addressedToType,addressedToSpecific:e.addressedToSpecific,referenceCode:e.referenceCode,youtubeVideoUrl:e.youtubeVideoUrl,tags:e.tags}}}if(0===t)return console.log("❌ Petition not found, retrying in 3 seconds..."),await new Promise(e=>setTimeout(e,3e3)),U(e,1);if(1===t)return console.log("❌ Petition still not found, final retry in 5 seconds..."),await new Promise(e=>setTimeout(e,5e3)),U(e,2);return console.log("❌ Petition not found in database after all retries"),null}console.log("✅ Petition found, processing data...");let g=p.data(),m={id:p.id,title:g.title,description:g.description,category:g.category,subcategory:g.subcategory,targetSignatures:g.targetSignatures,currentSignatures:g.currentSignatures||0,status:g.status,creatorId:g.creatorId,creatorPageId:g.creatorPageId,mediaUrls:g.mediaUrls||[],qrCodeUrl:g.qrCodeUrl,hasQrCode:g.hasQrCode||!1,pricingTier:g.pricingTier,amountPaid:g.amountPaid||0,paymentStatus:g.paymentStatus||"unpaid",location:g.location,createdAt:(null===(r=g.createdAt)||void 0===r?void 0:r.toDate)?g.createdAt.toDate():g.createdAt||new Date,updatedAt:(null===(i=g.updatedAt)||void 0===i?void 0:i.toDate)?g.updatedAt.toDate():g.updatedAt||new Date,approvedAt:(null===(n=g.approvedAt)||void 0===n?void 0:n.toDate)?g.approvedAt.toDate():g.approvedAt,pausedAt:(null===(s=g.pausedAt)||void 0===s?void 0:s.toDate)?g.pausedAt.toDate():g.pausedAt,deletedAt:(null===(c=g.deletedAt)||void 0===c?void 0:c.toDate)?g.deletedAt.toDate():g.deletedAt,viewCount:g.viewCount||0,shareCount:g.shareCount||0,moderatedBy:g.moderatedBy,moderationNotes:g.moderationNotes,isPublic:!1!==g.isPublic,isActive:!1!==g.isActive,publisherType:g.publisherType,publisherName:g.publisherName,petitionType:g.petitionType,addressedToType:g.addressedToType,addressedToSpecific:g.addressedToSpecific,referenceCode:g.referenceCode,youtubeVideoUrl:g.youtubeVideoUrl,tags:g.tags};return console.log("✅ Petition processed successfully:",m.id),m}catch(t){return console.error("❌ Error getting petition:",t),console.error("❌ Error details:",{petitionIdOrSlug:e,error:t instanceof Error?t.message:t}),null}},k=async function(e,t,r){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",u=new Date;try{let d=await U(e);if(!d)throw await n({petitionId:e,ipAddress:s,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:"Petition not found"}),Error("Petition not found");if("approved"!==d.status)throw await n({petitionId:e,ipAddress:s,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:"Petition not approved"}),Error("This petition is not available for signing");if(d.currentSignatures>=d.targetSignatures)throw await n({petitionId:e,ipAddress:s,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:"Target reached"}),Error("This petition has reached its signature goal");let p=await l(e,t.phone,s,c);if(!p.valid)throw await n({petitionId:e,ipAddress:s,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:p.reason}),Error(p.reason||"Security validation failed");if(t.comment){let a=T(t.comment);if(!a.approved)throw await n({petitionId:e,ipAddress:s,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:"Comment moderation failed: ".concat(a.reasons.join(", "))}),Error("Your comment contains inappropriate content. Please revise and try again.")}if(r&&await N(e,r))throw Error("You have already signed this petition");if(await R(e,t.phone))throw Error("This phone number has already been used to sign this petition");let m=g(t.phone,s,c,u),h={petitionId:e,signerName:t.isAnonymous?"Anonymous":t.name,signerPhone:t.phone,signerLocation:t.location,verificationMethod:"phone_otp",verifiedAt:u,ipAddress:s,userAgent:c,fingerprint:m,isAnonymous:t.isAnonymous||!1,comment:t.comment,createdAt:u};await (0,a.addDoc)((0,a.collection)(o.db,I),{...h,verifiedAt:a.Timestamp.fromDate(h.verifiedAt),createdAt:a.Timestamp.fromDate(h.createdAt)});let y=(0,a.doc)(o.db,E,e);await (0,a.updateDoc)(y,{currentSignatures:(0,a.nP)(1),updatedAt:a.Timestamp.fromDate(new Date)});let f=d.currentSignatures+1,w=f/d.targetSignatures*100;for(let t of[25,50,75,100]){let r=d.currentSignatures/d.targetSignatures*100;if(w>=t&&r<t){try{await (0,i.V1)(e,d.creatorId,d.title,f,t)}catch(e){console.error("Error sending milestone notification:",e)}break}}await n({petitionId:e,ipAddress:s,userAgent:c,phoneNumber:t.phone,userId:r,success:!0})}catch(i){console.error("Error signing petition:",i);let a=i instanceof Error?i.message:"Unknown error";throw a.includes("already been used")||a.includes("Too many signatures")||a.includes("inappropriate content")||await n({petitionId:e,ipAddress:s,userAgent:c,phoneNumber:t.phone,userId:r,success:!1,reason:a}),Error("Failed to sign petition. Please try again.")}},N=async(e,t)=>{try{let r=(0,a.query)((0,a.collection)(o.db,I),(0,a.where)("petitionId","==",e),(0,a.where)("userId","==",t),(0,a.b9)(1));return!(await (0,a.getDocs)(r)).empty}catch(e){return console.error("Error checking existing signature:",e),!1}},R=async(e,t)=>{try{let r=(0,a.query)((0,a.collection)(o.db,I),(0,a.where)("petitionId","==",e),(0,a.where)("signerPhone","==",t),(0,a.b9)(1));return!(await (0,a.getDocs)(r)).empty}catch(e){return console.error("Error checking phone signature:",e),!1}},F=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{page:1,limit:12,total:0,hasMore:!1};try{let r=(0,a.query)((0,a.collection)(o.db,E));r=e.status?(0,a.query)(r,(0,a.where)("status","==",e.status)):(0,a.query)(r,(0,a.where)("status","==","approved")),e.category&&(r=(0,a.query)(r,(0,a.where)("category","==",e.category)));let i="popular"===e.sortBy?"currentSignatures":"signatures"===e.sortBy?"currentSignatures":"createdAt",n=e.sortOrder||"desc";r=(0,a.query)(r,(0,a.orderBy)(i,n)),t.limit&&(r=(0,a.query)(r,(0,a.b9)(t.limit+1)));let s=await (0,a.getDocs)(r),c=[];s.docs.forEach((e,r)=>{var a,i,o,n,s;if(t.limit&&r>=t.limit)return;let u=e.data();c.push({id:e.id,title:u.title,description:u.description,category:u.category,subcategory:u.subcategory,targetSignatures:u.targetSignatures,currentSignatures:u.currentSignatures||0,status:u.status,creatorId:u.creatorId,creatorPageId:u.creatorPageId,mediaUrls:u.mediaUrls||[],qrCodeUrl:u.qrCodeUrl,hasQrCode:u.hasQrCode||!1,pricingTier:u.pricingTier,amountPaid:u.amountPaid||0,paymentStatus:u.paymentStatus||"unpaid",location:u.location,createdAt:(null===(a=u.createdAt)||void 0===a?void 0:a.toDate())||new Date,updatedAt:(null===(i=u.updatedAt)||void 0===i?void 0:i.toDate())||new Date,approvedAt:null===(o=u.approvedAt)||void 0===o?void 0:o.toDate(),pausedAt:null===(n=u.pausedAt)||void 0===n?void 0:n.toDate(),deletedAt:null===(s=u.deletedAt)||void 0===s?void 0:s.toDate(),viewCount:u.viewCount||0,shareCount:u.shareCount||0,moderatedBy:u.moderatedBy,moderationNotes:u.moderationNotes,isPublic:!1!==u.isPublic,isActive:!1!==u.isActive})});let u=c;if(e.search){let t=e.search.toLowerCase();u=c.filter(e=>e.title.toLowerCase().includes(t)||e.description.toLowerCase().includes(t))}e.location&&(u=u.filter(t=>{var r,a;return(null===(r=t.location)||void 0===r?void 0:r.country)===e.location||(null===(a=t.location)||void 0===a?void 0:a.city)===e.location}));let d={page:t.page||1,limit:t.limit||12,total:u.length,hasMore:u.length===t.limit};return{petitions:u,pagination:d}}catch(e){throw console.error("Error getting petitions:",e),Error("Failed to load petitions. Please try again.")}},M=async e=>{try{let t=(0,a.query)((0,a.collection)(o.db,E),(0,a.where)("creatorId","==",e),(0,a.orderBy)("createdAt","desc")),r=await (0,a.getDocs)(t),i=[];return r.forEach(e=>{var t,r,a,o,n;let s=e.data();i.push({id:e.id,title:s.title,description:s.description,category:s.category,subcategory:s.subcategory,targetSignatures:s.targetSignatures,currentSignatures:s.currentSignatures||0,status:s.status,creatorId:s.creatorId,creatorPageId:s.creatorPageId,mediaUrls:s.mediaUrls||[],qrCodeUrl:s.qrCodeUrl,hasQrCode:s.hasQrCode||!1,pricingTier:s.pricingTier,amountPaid:s.amountPaid||0,paymentStatus:s.paymentStatus||"unpaid",location:s.location,createdAt:(null===(t=s.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(r=s.updatedAt)||void 0===r?void 0:r.toDate())||new Date,approvedAt:null===(a=s.approvedAt)||void 0===a?void 0:a.toDate(),pausedAt:null===(o=s.pausedAt)||void 0===o?void 0:o.toDate(),deletedAt:null===(n=s.deletedAt)||void 0===n?void 0:n.toDate(),viewCount:s.viewCount||0,shareCount:s.shareCount||0,moderatedBy:s.moderatedBy,moderationNotes:s.moderationNotes,isPublic:!1!==s.isPublic,isActive:!1!==s.isActive})}),i}catch(e){throw console.error("Error getting user petitions:",e),Error("Failed to load your petitions. Please try again.")}},B=async(e,t,r,i)=>{try{let n=(0,a.doc)(o.db,E,e),s={status:t,moderatedBy:r,updatedAt:a.Timestamp.fromDate(new Date)};i&&(s.moderationNotes=i),"approved"===t?s.approvedAt=a.Timestamp.fromDate(new Date):"paused"===t?s.pausedAt=a.Timestamp.fromDate(new Date):"deleted"===t&&(s.deletedAt=a.Timestamp.fromDate(new Date),s.isActive=!1),await (0,a.updateDoc)(n,s)}catch(e){throw console.error("Error updating petition status:",e),Error("Failed to update petition status. Please try again.")}},L=async e=>{try{let t=(0,a.doc)(o.db,E,e);await (0,a.updateDoc)(t,{shareCount:(0,a.nP)(1),updatedAt:a.Timestamp.fromDate(new Date)})}catch(e){console.error("Error incrementing petition shares:",e)}},V=async()=>{try{let e=(0,a.collection)(o.db,q),t=await (0,a.getDocs)(e),r=[];if(t.forEach(e=>{let t=e.data();if(!1!==t.isActive){var a,i;r.push({id:e.id,name:t.name,description:t.description,icon:t.icon,color:t.color,isActive:!1!==t.isActive,petitionCount:t.petitionCount||0,createdAt:(null===(a=t.createdAt)||void 0===a?void 0:a.toDate())||new Date,updatedAt:(null===(i=t.updatedAt)||void 0===i?void 0:i.toDate())||new Date})}}),0===r.length)return console.log("No categories found in database, using defaults"),C.DEFAULT_CATEGORIES.map((e,t)=>({id:"default-".concat(t),...e,petitionCount:0,createdAt:new Date,updatedAt:new Date}));return r.sort((e,t)=>e.name.localeCompare(t.name)),r}catch(e){return console.error("Error getting categories:",e),C.DEFAULT_CATEGORIES.map((e,t)=>({id:"default-".concat(t),...e,petitionCount:0,createdAt:new Date,updatedAt:new Date}))}};(async()=>{try{let e=(0,a.collection)(o.db,q);if((await (0,a.getDocs)(e)).empty){let t=new Date,r=C.DEFAULT_CATEGORIES.map(r=>(0,a.addDoc)(e,{...r,petitionCount:0,createdAt:a.Timestamp.fromDate(t),updatedAt:a.Timestamp.fromDate(t)}));await Promise.all(r),console.log("Default categories initialized")}}catch(e){console.error("Error initializing categories:",e)}})();let Q=async e=>{try{var t,r;let i=(0,a.doc)(o.db,"users",e),n=await (0,a.getDoc)(i);if(!n.exists())return null;let s=n.data();return{id:n.id,email:s.email||"",name:s.name||"",role:s.role||"user",phone:s.phone||"",verifiedEmail:s.emailVerified||!1,verifiedPhone:s.phoneVerified||!1,createdAt:(null===(t=s.createdAt)||void 0===t?void 0:t.toDate())||new Date,updatedAt:(null===(r=s.updatedAt)||void 0===r?void 0:r.toDate())||new Date,isActive:!1!==s.isActive,...s.bio&&{bio:s.bio},...s.photoURL&&{photoURL:s.photoURL}}}catch(e){return console.error("Error getting user:",e),null}},_=async(e,t)=>{try{let r=(0,a.doc)(o.db,E,e),i=await (0,a.getDoc)(r);if(!i.exists())throw Error("Petition not found");if(i.data().creatorId!==t)throw Error("Only the petition creator can delete this petition");await (0,a.updateDoc)(r,{status:"deleted",deletedAt:new Date,updatedAt:new Date})}catch(e){throw console.error("Error deleting petition:",e),e}},O=async(e,t)=>{try{let r=(0,a.doc)(o.db,E,e),i=await (0,a.getDoc)(r);if(!i.exists())throw Error("Petition not found");if(i.data().creatorId!==t)throw Error("Only the petition creator can archive this petition");await (0,a.updateDoc)(r,{status:"archived",archivedAt:new Date,updatedAt:new Date})}catch(e){throw console.error("Error archiving petition:",e),e}},Y=async(e,t,r)=>{try{let i=(0,a.collection)(o.db,"deletion_requests");await (0,a.addDoc)(i,{petitionId:e,requestedBy:t,reason:r,status:"pending",createdAt:new Date})}catch(e){throw console.error("Error requesting petition deletion:",e),e}}}}]);
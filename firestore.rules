rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // PRODUCTION SECURITY RULES
    // Last updated: 2025-01-19
    
    // Helper functions for role checking
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isAdmin() {
      return isAuthenticated() && getUserData().role in ['admin', 'master_admin'];
    }
    
    function isModerator() {
      return isAuthenticated() && getUserData().role in ['moderator', 'admin', 'master_admin'];
    }
    
    // Users collection - Users can read all, but only update their own profile
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin(); // Only admins can delete users
    }
    
    // Petitions collection - Public read, restricted write
    match /petitions/{petitionId} {
      // Anyone can read approved petitions, creators can read their own
      allow read: if true;
      
      // Authenticated users can create petitions with valid data
      allow create: if isAuthenticated() 
        && request.resource.data.creatorId == request.auth.uid
        && request.resource.data.title is string
        && request.resource.data.title.size() > 0
        && request.resource.data.description is string
        && request.resource.data.description.size() > 0;
      
      // Only creator or admin can update
      allow update: if isAuthenticated() 
        && (resource.data.creatorId == request.auth.uid || isAdmin())
        && request.resource.data.creatorId == resource.data.creatorId; // Can't change creator
      
      // Only creator or admin can delete
      allow delete: if isAuthenticated() 
        && (resource.data.creatorId == request.auth.uid || isAdmin());
    }
    
    // Signatures collection - Public read, restricted write
    match /signatures/{signatureId} {
      allow read: if true; // Public signatures for transparency
      
      // Authenticated users can create signatures
      allow create: if isAuthenticated()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.petitionId is string;
      
      // Only signature owner or admin can update/delete
      allow update, delete: if isAuthenticated() 
        && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Creator pages collection - Public read, owner write
    match /creatorPages/{pageId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() 
        && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Categories collection - Public read, admin write only
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAdmin(); // Only admins can manage categories
    }
    
    // Comments collection - Allow public read and authenticated write
    match /comments/{commentId} {
      allow read: if true;
      allow create: if request.auth != null;
      // Only comment author can update/delete their own comments
      allow update, delete: if request.auth != null && 
        (request.auth.uid == resource.data.authorId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'master_admin');
    }
    
    // Petition updates collection - Public read, creator write
    match /petitionUpdates/{updateId} {
      allow read: if true;
      
      // Only petition creator can create updates
      allow create: if isAuthenticated()
        && request.resource.data.authorId == request.auth.uid;
      
      // Only update author or admin can modify/delete
      allow update, delete: if isAuthenticated() 
        && (resource.data.authorId == request.auth.uid || isAdmin());
    }
    
    // Notifications collection - Users can only read/update their own notifications
    match /notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Deletion requests collection - Creators can create, admins can read/update
    match /deletion_requests/{requestId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'master_admin');
      allow delete: if false; // Deletion requests should never be deleted
    }
    
    // Moderators collection - Admin only
    match /moderators/{moderatorId} {
      allow read: if isModerator();
      allow write: if isAdmin(); // Only admins can manage moderators
    }
    
    // Payments collection - User can read their own, admin can read all
    match /payments/{paymentId} {
      allow read: if isAuthenticated() 
        && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin(); // Only admins can update payment status
      allow delete: if false; // Never delete payment records
    }
    
    // QR codes collection - Public read, owner write
    match /qrCodes/{qrCodeId} {
      allow read: if true;
      allow create: if isAuthenticated() && request.resource.data.petitionId is string;
      allow update, delete: if isAuthenticated() 
        && (resource.data.creatorId == request.auth.uid || isAdmin());
    }
    
    // Audit logs collection - Allow admins/moderators to read and write
    match /auditLogs/{logId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if false; // Audit logs should never be modified or deleted
    }
    
    // Deny all other collections by default (secure by default)
    // Add specific rules above for any new collections
  }
}